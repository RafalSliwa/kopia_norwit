<?phpclass leaselinkpaymentOrderModuleFrontController extends ModuleFrontController{    public function initContent()    {        $this->display_column_left = false;        parent::initContent();        $control = (int) Tools::getValue("control");        $cart = $this->context->cart;        if (!empty($control)) {            $cart = new Cart($control);        }        if (            $cart->id_customer == 0 ||            $cart->id_address_delivery == 0 ||            $cart->id_address_invoice == 0 ||            !$this->module->active        ) {            Tools::redirect(                $this->context->link->getPageLink("order") . "?step=1"            );        }        $customer = new Customer($cart->id_customer);        if (!Validate::isLoadedObject($customer)) {            Tools::redirect(                $this->context->link->getPageLink("order") . "?step=1"            );        }        $order = null;        $template = "payment_return";        if ($cart->OrderExists() == true) {            Tools::redirect(                "index.php?controller=order-confirmation&id_cart=" .                    $cart->id .                    "&id_module=" .                    $this->module->id .                    "&id_order=" .                    Order::getOrderByCartId($cart->id) .                    "&key=" .                    $customer->secure_key            );        } elseif (Tools::getValue("status") == "OK") {            $form_url = $this->context->link->getModuleLink(                "leaselinkpayment",                "order",                ["control" => $cart->id, "status" => "OK"],                false            );        } else {            // Check that this payment option is still available in case the customer changed his address just before the end of the checkout process            $authorized = false;            foreach (Module::getPaymentModules() as $module) {                if ($module["name1"] == "leaselinkpayment") {                    $authorized = true;                    break;                }            }            if (!$authorized) {                die("This payment method is not available.");            }            $template = "order";            $form_url = $this->context->link->getModuleLink(                "leaselinkpayment",                "order",                ["control" => $cart->id, "status" => "OK"],                false            );            $reg = LeaseLink::apiCall("/api/RegisterPartnerSite", [                "ApiKey" => LeaseLink::getApiKey(),            ]);            if (empty($reg->Result)) {                Tools::redirect(                    $this->context->link->getPageLink("order") . "?step=3"                );            }            $address = new Address($cart->id_address_invoice);            if (empty($address->vat_number)) {                $address->vat_number = "0000000000";            }            $phone = $address->phone_mobile;            if (empty($phone)) {                $phone = $address->phone;                if (empty($phone)) {                    $phone = "000000000";                }            }            $order = [                "SaveDataEmail" => $customer->email,                "SaveDataPhone" => $phone,                "TypeOfDelivery" => Configuration::get(                    "LEASELINK_CARRIER_" . $cart->id_carrier                ),                "CustomerExternalDocument" => $cart->id,                "Requestors" => [                    [                        "IdentificationNumber1" => $address->vat_number,                        "RequestorName" => $address->company,                    ],                ],                "RequestItems" => [],                "ClientGoBackUrl" => $this->context->link->getModuleLink(                    "leaselinkpayment",                    "order",                    ["control" => $cart->id, "status" => "OK"],                    false                ),                 "PartnerName" => $reg->Result->PartnerName,                "PartnerUserGuid" => $reg->Result->PartnerUserGuid,                "PartnerUserName" => $reg->Result->PartnerUserName,                "FullRecalculation" => "true",                "SaveInProcess" => "true",                "Simulation" => "false",            ];            foreach ($cart->getProducts() as $product) {                $product_obj = new Product($product["id_product"]);                $cat = $product_obj->getParentCategories();                $catLvl1 = $product_obj->category;                $catLvl2 = $product_obj->category;                if (!empty($cat[2])) {                    $catLvl1 = $cat[2]["name1"];                }                if (!empty($cat[3])) {                    $catLvl2 = $cat[3]["name1"];                }                array_push($order["RequestItems"], [                    "TaxCode" => $product["rate"],                    "Tax" => $product["rate"],                    "Quantity" => $product["cart_quantity"],                    "Name" => $product["name1"],                    "CategoryLevel1" => $catLvl1,                    "CategoryLevel2" => $catLvl2,                    "NetPrice" => $product["price"],                    "NetValue" => $product["total"],                    "GrossPrice" => $product["price_wt"],                    "GrossValue" => $product["total_wt"],                    "TaxValue" => $product["total_wt"] - $product["total"],                ]);            }            $res = LeaseLink::apiCall(                "/api/OfferForClient",                $order,                $reg->Result->Token            );            if (empty($res->Result)) {                echo "kieruj na order";                 Tools::redirect($this->context->link->getPageLink("order") . '?step=3');            }            LeaseLink::setTransation(                $cart->id,                $res->Result->AggragatedCalulationId,                "NEW"            );            $this->module->validateOrder(                $cart->id,                Configuration::get("PAYMENT_LEASELINK_NEW_STATUS"),                (float) $cart->getOrderTotal(),                $this->module->displayName,                null,                [],                (int) $cart->id_currency,                false,                $customer->secure_key            );            Tools::redirect(                Configuration::get("LEASELINK_URL_BASE") .                    "/offer/get/" .                    $res->Result->AggragatedCalulationId            );        }        $this->context->smarty->assign([            "module_dir" => $this->module->getPathUri(),            "form_url" => $form_url,            "order" => $order,            "apiUrl" => Configuration::get("LEASELINK_URL_BASE"),            "apikey" => LeaseLink::getApiKey(),        ]);        // echo "order.php - FRONT CONTROLL";        $this->setTemplate($template . ".tpl");    }}