<?php/*** NOTICE OF LICENSE** This source file is subject to the Academic Free License (AFL 3.0)* that is bundled with this package in the file LICENSE.txt.* It is also available through the world-wide-web at this URL:* http://opensource.org/licenses/afl-3.0.php* If you did not receive a copy of the license and are unable to* obtain it through the world-wide-web, please send an email* to license@prestashop.com so we can send you a copy immediately.** DISCLAIMER** Do not edit or add to this file if you wish to upgrade PrestaShop to newer* versions in the future. If you wish to customize PrestaShop for your* needs please refer to http://www.prestashop.com for more information.**  @author    LeaseLink*  @copyright LeaseLink*  @license   http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0) */// use Order;    class leaselinkpaymentCallbackModuleFrontController extends ModuleFrontController{          public function displayAjax()// initContent()//LICZĄ SIĘ DLA NAS RELACJE     {          				$configuration = [			"API_KEY" => empty($this->isTest)? Configuration::get('LEASELINK_PRODAPI_ID') : Configuration::get('LEASELINK_TESTAPI_ID'), 			"URL_BASE" =>  empty($this->isTest)? Configuration::get('LEASELINK_URL_BASE') : Configuration::get('LEASELINK_URL_TEST'), //"https://online.leaselink.pl/offerrequest/confirmstatus",			"DEBUG" => false,		];   		           $LeaseLinkApi = new LeaseLinkApi( $configuration  );  		$LeaseLinkApi->debugLog($_SERVER);  				$json_input_data = json_decode(Tools::file_get_contents('php://input'), true); 		if ($_SERVER['REQUEST_METHOD'] <> 'POST') {            die("PrestaShop - ERROR: Invalid Request 1");        }        if (empty($_SERVER["HTTP_X_AUTH_LEASELINK"])) {            die("PrestaShop - ERROR: Invalid Request 2");        }         if (!isset($json_input_data["TransactionId"])) {            die("PrestaShop - ERROR: Invalid Request 3");        }        if (!isset($json_input_data["CustomerExternalDocument"])) {            die("PrestaShop - ERROR: Invalid Request 3");        }				 		        // $apiReqest = "/api/ClientTransactionStatus/". $json_input_data["TransactionId"]."?attachments=true";        // $apiResponse = LeaseLink::apiGet($apiReqest, $_SERVER["HTTP_X_AUTH_LEASELINK"]);        // if (empty($apiResponse) or !is_object($apiResponse) or empty($apiResponse->Result)) {            // die("PrestaShop - ERROR: Invalid Api Response for: GET " .$apiReqest ." RESPONSE: " . $apiResponse );        // }        // $cart = new Cart((int)$apiResponse->Result->CustomerExternalDocument);        $cart = new Cart((int)$json_input_data["CustomerExternalDocument"]);        if (!Validate::isLoadedObject($cart)) {             die("PrestaShop - ERROR: Invalid CustomerExternalDocument: " .(int)$json_input_data["CustomerExternalDocument"] );        }        $customer = new Customer((int)$cart->id_customer);        $skipUpdate = false;        switch ($json_input_data["StatusName"])          {            case 'PROCESSING':                $actual_state = Configuration::get('LL_ORDER_STATE_1');                break;            case 'SEND_ASSET'://++                $actual_state = Configuration::get('LL_ORDER_STATE_2');                 break;            case 'SIGN_CONTRACT':                  $actual_state = Configuration::get('LL_ORDER_STATE_3');                 break;            case 'CANCELLED':                $actual_state = Configuration::get('LL_ORDER_STATE_5');                break;				            case 'ASSET_IN_WAY':                $skipUpdate = true;                break;            case 'ASSET_DELIVERED':                $skipUpdate = true;                break;            case 'NEED_DATA':                $actual_state = _PS_OS_ERROR__;                break;             case 'FINISHED':                $actual_state = Configuration::get('LL_ORDER_STATE_2');                break;            default:                die ("PrestaShop - WRONG TRANSACTION STATUS");        }         $attachments = null;		if(	isset($json_input_data["Attachments"]) && is_array($json_input_data["Attachments"])){			foreach ($json_input_data["Attachments"] as $attachment) {				$attachments[] = $attachment->AttachmentId;			}		}				//ustawia nowy sytatus zamowienia na nowo po akceptacji dancyh        LeaselinkPayment::setTransation($cart->id, $json_input_data["TransactionId"] ,$json_input_data["StatusName"], $attachments);        if (!$skipUpdate) {            if ($cart->OrderExists() == false) {                $this->module->validateOrder($cart->id, $actual_state, (float)$cart->getOrderTotal(), $this->module->displayName, null, [], (int)$cart->id_currency, false, $customer->secure_key);            } else {                $history = new OrderHistory();                  $history->id_order = Order::getOrderByCartId((int)$cart->id);                 				$history->changeIdOrderState($actual_state, $history->id_order);                $history->addWithemail(true);                            }        }        echo "OK" ;      }}