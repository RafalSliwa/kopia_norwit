<?php/** 2007-2015 PrestaShop** NOTICE OF LICENSE** This source file is subject to the Academic Free License (AFL 3.0)* that is bundled with this package in the file LICENSE.txt.* It is also available through the world-wide-web at this URL:* http://opensource.org/licenses/afl-3.0.php* If you did not receive a copy of the license and are unable to* obtain it through the world-wide-web, please send an email* to license@prestashop.com so we can send you a copy immediately.** DISCLAIMER** Do not edit or add to this file if you wish to upgrade PrestaShop to newer* versions in the future. If you wish to customize PrestaShop for your* needs please refer to http://www.prestashop.com for more information.**  @author PrestaShop SA <contact@prestashop.com>*  @copyright  2007-2015 PrestaShop SA*  @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)*  International Registered Trademark & Property of PrestaShop SA*//** * @since 1.5.0 leaselinkpayment */  class LeaselinkpaymentvalidationLeasingModuleFrontController extends ModuleFrontController{	/** 	 * @see FrontController::postProcess()	 */	public function postProcess()	{  	 		$cart = $this->context->cart; 	 	        if ($cart->id_customer == 0 || $cart->id_address_delivery == 0 || $cart->id_address_invoice == 0 || !$this->module->active)            Tools::redirect('index.php?controller=order&step=1');        // Check that this payment option is still available in case the customer changed his address just before the end of the checkout process        $authorized = false;        foreach (Module::getPaymentModules() as $module)            if ($module['name'] == 'leaselinkpayment') {                $authorized = true;                break;            }        if (!$authorized)            die($this->module->getTranslator()->trans('This payment method is not available.', array(), 'Modules.Leaselinkpayment.Shop'));   				$currency = $this->context->currency;        $total = floatval(number_format($cart->getOrderTotal(true, 3), 2, '.', ''));         		$mailVars = array(			 '{paymentlease_owner}' => 'info mail 1 w VALIDLEASING',			 '{paymentlease_details}' => 'info mail 2 w VALIDLEASING',			 '{paymentlease_address}' => nl2br('info mail 3 w VALIDLEASING')		);	 			 			 			 		$customer = new Customer($cart->id_customer);        if (!Validate::isLoadedObject($customer)) {            Tools::redirect($this->context->link->getPageLink("order") . '?step=1');        }	 			 			 		$order = null;        $template = "payment";        if ($cart->OrderExists() == true) {             Tools::redirect('index.php?controller=order-confirmation&id_cart=' . $cart->id . '&id_module=' . $this->module->id . '&id_order=' . Order::getOrderByCartId($cart->id) . '&key=' . $customer->secure_key);        } elseif (Tools::getValue("status") == "OK") {             $form_url = $this->context->link->getModuleLink('leaselinkpayment', 'order', array('control' => $cart->id, 'status' => 'OK'), false);        } else {	 			 		            $template = "order";              $form_url = $this->context->link->getModuleLink('leaselinkpayment', 'order', array('control' => $cart->id, 'status' => 'OK'), false);		  			$configuration = [				"API_KEY" => empty($this->isTest)? Configuration::get('LEASELINK_PRODAPI_ID') : Configuration::get('LEASELINK_TESTAPI_ID'), 				"URL_BASE" =>  empty($this->isTest)? Configuration::get('LEASELINK_URL_BASE') : Configuration::get('LEASELINK_URL_TEST'), //"https://online.leaselink.pl/offerrequest/confirmstatus",				"DEBUG" => false,				];   		    		    $LeaseLinkApi = new LeaseLinkApi( $configuration  ); 			$myAPI = empty($this->isTest)? Configuration::get('LEASELINK_PRODAPI_ID') : Configuration::get('LEASELINK_TESTAPI_ID');			$reg = $LeaseLinkApi->apiCall('/api/RegisterPartnerSite', [					'ApiKey' => $myAPI				]);			             if (empty($reg->Result)) {                 Tools::redirect($this->context->link->getPageLink("order") . '?step=3');            }            $address = new Address($cart->id_address_invoice);             if (empty($address->vat_number)) {                $address->vat_number = "0000000000";            }             $phone = $address->phone_mobile;            if (empty($phone)) {                  $phone = $address->phone;                if (empty($phone)) {                    $phone = "000000000";                }            }            $order = array(                "SaveDataEmail" => $customer->email,                "SaveDataPhone" => $phone,                "TypeOfDelivery" => Configuration::get("LEASELINK_CARRIER_" .$cart->id_carrier),                "CustomerExternalDocument" => $cart->id,                "Requestors" => array(array(                    "IdentificationNumber1" => $address->vat_number,                    "RequestorName" => $address->company                )),                "RequestItems" => array(),                "ClientGoBackUrl" => $this->context->link->getModuleLink('leaselink', 'order', array('control' => $cart->id, 'status' => 'OK'), false),                'PartnerName' => $reg->Result->PartnerName,                'PartnerUserGuid' => $reg->Result->PartnerUserGuid,                'PartnerUserName' => $reg->Result->PartnerUserName,                'FullRecalculation'=>'true',                'SaveInProcess'=>'true',                'Simulation'=>'false'            );            foreach ($cart->getProducts() as $product) {                $product_obj = new Product($product['id_product']);                $cat = $product_obj->getParentCategories();                $catLvl1 = $product_obj->category;                $catLvl2 = $product_obj->category;                if (!empty($cat[2])) {                    $catLvl1 = $cat[2]['name'];                }                if (!empty($cat[3])) {                    $catLvl2 = $cat[3]['name'];                }                array_push($order["RequestItems"], array(                    "TaxCode" => $product["rate"],                    "Tax" => $product["rate"],                    "Quantity" => $product["cart_quantity"],                    "Name" => $product["name"],                    "CategoryLevel1" => $catLvl1,                    "CategoryLevel2" => $catLvl2,                    "NetPrice" => $product["price"],                    "NetValue" => $product["total"],                    "GrossPrice" => $product["price_wt"],                    "GrossValue" => $product["total_wt"],                    "TaxValue" => $product["total_wt"] - $product["total"]                ));            };            $res = $LeaseLinkApi->apiCall('/api/OfferForClient', $order, $reg->Result->Token);             			if (empty($res->Result)) { 			               Tools::redirect($this->context->link->getPageLink("order") . '?step=3');            } 			  			  			$Leaselinkpayment = new Leaselinkpayment();			//ustaw nowy status zamowienia			$useOrderState =   Configuration::get('LEASELINK_INFO_STARUS_LL_PRZYPIS1');			$Leaselinkpayment->setTransation($cart->id, $res->Result->AggragatedCalulationId, 'NEW'); 			$this->module->validateOrder($cart->id,$useOrderState, $total, $this->module->displayName, NULL, $mailVars, (int)$currency->id, false, $customer->secure_key); 			Tools::redirect(Configuration::get('LEASELINK_URL_BASE'). "/offer/get/". $res->Result->AggragatedCalulationId);		}		     		 $this->context->smarty->assign(array(            'module_dir' => $this->module->getPathUri(),            'form_url' => $form_url,            'order' => $order,			'errors' => $errors,             'apiUrl' => Configuration::get('LEASELINK_URL_BASE'),            'apikey' => LeaseLink::getApiKey()            ));				$this->setTemplate($template.".tpl");    	}}