<?phpinclude_once __DIR__."/tools/Tools.php";class LeaseLinkApi{	    private $apiKey;    private $apiUrl;  	 	    protected $configuration = [        "API_KEY" => "",         "URL_BASE" =>"https://online.leaselink.pl/offerrequest/confirmstatus",        "DEBUG" => false,    ];    public function __construct($configuration)    {        $this->configuration = array_merge(            $this->configuration,            $configuration        );    }    protected function get($key, $throw = true)    {        if (empty($key)) {            if ($throw) {                throw new InvalidArgumentException("Empty key");            }            return null;        }        if (!isset($this->configuration[$key])) {            if ($throw) {                throw new InvalidArgumentException("Unknown key: " . $key);            }            return null;        }        return $this->configuration[$key];    }    public function debugLog($log)    {        $debug = $this->get("DEBUG", false);        if (!empty($debug)) {            error_log(print_r($log, true));        }    }    protected function getApiKey()    {        return $this->get("API_KEY");    }    protected function getUrlBase()    {        return $this->get("URL_BASE");    }    public function apiCall($uri, $params, $token = null)    {        $data = http_build_query($params);         $dl = Tools::strlen($data);         $http_context = stream_context_create([            "http" => [                "method" => "POST",                 "header" => "Content-Type: application/json; charset=UTF-8\r\nContentLength: $dl\r\n",                "header" => "Authorization: Bearer $token \r\n",                 "timeout" => 40.0,                 "ignore_errors" => true, # return body even if HTTP status != 200                "content" => $data,             ],        ]);        //  print_r( $http_context);        return json_decode(            Tools::file_get_contents(                $this->getUrlBase() . $uri,                false,                $http_context            )        );    }    public function apiGet($uri, $token)    {        $http_context = stream_context_create([            "http" => [                "method" => "GET",                 "header" => "Authorization: Bearer $token \r\n",            ],        ]);        return json_decode(            Tools::file_get_contents(                $this->getUrlBase() . $uri,                false,                $http_context            )        );    }    public function apiRegisterPartnerSite()    {        $params = [            "ApiKey" => $this->getApiKey(),         ];        $reg = $this->apiCall("/api/RegisterPartnerSite", $params);        //print_r( $reg->Result);        if (empty($reg->Result)) {            $this->debugLog($params);            $this->debugLog($reg);            throw new Exception("RegisterPartnerSite Failed");        }        return $reg->Result;    }    public function apiOfferForClient($order = [])    {        if (empty($order)) {            throw new InvalidArgumentException("Empty order");        }        $reg = $this->apiRegisterPartnerSite();        //$order = array_merge(            [             ],            $order        );        $apiResponse = $this->apiCall(            "/api/OfferForClient",            $order,            $reg->Token        );        if (empty($apiResponse->Result)) {            $this->debugLog($order);            $this->debugLog($apiResponse);            throw new Exception("OfferForClient Failed");        }        return $apiResponse->Result;    }    public function apiGetOffer($order = [])    {        $apiResponse = $this->apiOfferForClient(            array_merge(                [                    "FullRecalculation" => "true",                    "SaveInProcess" => "true",                    "Simulation" => "false",                ],                $order            )        );        return $this->getUrlBase() .            "/offer/get/" .            $apiResponse->AggragatedCalulationId;    }    public function apiCalculateOffer($order = [])    {        $apiResponse = $this->apiOfferForClient(            array_merge(                [                    "FullRecalculation" => "true",                     "SaveInProcess" => "false",                     "Simulation" => "true",                ],                $order            )        );        return $apiResponse->OfferItems;    }    public function apiCalculateOfferForItems($requestItems = [])    {        if (empty($requestItems)) {            throw new InvalidArgumentException("Empty Request Items");        }        return $this->apiCalculateOffer([            "TypeOfDelivery" => 1,             "CustomerExternalDocument" => 1234,             "RequestItems" => $requestItems,        ]);    }    public function apiClientTransactionStatus(        $transationId,        $token = null,        $attachments = true    ) {        if (empty($transationId)) {            throw new InvalidArgumentException("Empty transationId");        }        if (empty($token)) {            throw new InvalidArgumentException("Empty token");        }        $apiReqest =            "/api/ClientTransactionStatus/" .            $transationId .            "?attachments=" .            $attachments;        $apiResponse = $this->apiGet($apiReqest, $token);        if (empty($apiResponse->Result)) {            $this->debugLog($apiReqest);            $this->debugLog($apiResponse);            throw new Exception("ClientTransactionStatus Failed");        }        return $apiResponse->Result;    }}