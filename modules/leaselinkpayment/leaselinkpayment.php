<?php/** 2007-2023 PrestaShop** NOTICE OF LICENSE** This source file is subject to the Academic Free License (AFL 3.0)* that is bundled with this package in the file LICENSE.txt.* It is also available through the world-wide-web at this URL:* http://opensource.org/licenses/afl-3.0.php* If you did not receive a copy of the license and are unable to* obtain it through the world-wide-web, please send an email* to license@prestashop.com so we can send you a copy immediately.** DISCLAIMER** Do not edit or add to this file if you wish to upgrade PrestaShop to newer* versions in the future. If you wish to customize PrestaShop for your* needs please refer to http://www.prestashop.com for more information.**  @author PrestaShop SA <contact@prestashop.com>*  @copyright  2007-2023 PrestaShop SA*  @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)*  International Registered Trademark & Property of PrestaShop SA*/use PrestaShop\PrestaShop\Core\Payment\PaymentOption; // include_once(__DIR__.'/sdk/tools/Tools.php');  include_once(__DIR__.'/sdk/LeaseLinkApi.php'); if (!defined('_PS_VERSION_')) {     exit; }  class Leaselinkpayment extends PaymentModule {        const BASEURL_LEASELINK_TEST = 'https://onlinetest.leaselink.pl';     const BASEURL_LEASELINK = 'https://online.leaselink.pl';    const EMAIL_LEASELINK =  'presta@leaselink.pl';          protected $_html = '';    protected $_postErrors = [];    public $details;    public $owner;    public $address;    public $extra_mail_vars;    public $currencies;    public $is_eu_compatible;    public $bootstrap;    public $author;    public $isSSL;    public $klientid;    public $testapi;    public $prodapi;    public $fields_form;     public function __construct() //OK    {        $this->name = 'leaselinkpayment';         $this->tab = 'payments_gateways';         $this->version = '3.3.1c';        $this->ps_versions_compliancy = ['min' => '1.8.0.0', 'max' => _PS_VERSION_];        $this->author = 'Projekt-Net';          $this->controllers = ['payment', 'validation'];          $this->is_eu_compatible = 1;             $this->currencies = true;              $this->bootstrap = true;        parent::__construct();                $this->displayName = $this->trans('Płatności LEASELINK', [], 'Modules.Leaselinkpayment.Admin');        $this->description = $this->trans('Płatności w formie leasingu.', [], 'Modules.Leaselinkpayment.Admin');                if (array_key_exists('HTTPS', $_SERVER) && $_SERVER['HTTPS'] == "on") {            $this->isSSL = true;        }                $config = Configuration::getMultiple(['LEASELINK_KLIENTID', 'LEASELINK_TESTAPI_ID','LEASELINK_PRODAPI_ID']);        if (!empty($config['LEASELINK_KLIENTID'])) {            $this->klientid = $config['LEASELINK_KLIENTID'];        }        if (!empty($config['LEASELINK_TESTAPI_ID'])) {            $this->testapi = $config['LEASELINK_TESTAPI_ID'];        }        if (!empty($config['LEASELINK_PRODAPI_ID'])) {            $this->prodapi = $config['LEASELINK_PRODAPI_ID'];        }                $this->confirmUninstall = $this->trans('Czy chcesz usunąć ten moduł?', [], 'Modules.Leaselinkpayment.Admin');        // czy ustawiono dane api i klientID         if (!isset($this->klientid) && !isset($this->prodapi) ) {            //             $this->warning = $this->trans('Ustawienia API nie zostaly skonfigurowane.', [], 'Modules.Leaselinkpayment.Admin');                 }                         // czy jest ustawiona waluta dla domeny        // if (!count(Currency::checkPaymentCurrencies($this->id))) {            // $this->warning = $this->trans('No currency has been set for this module.', [], 'Modules.Leaselinkpayment.Admin');        // }         if (extension_loaded('curl') == false)        {             $this->warning = $this->trans('Zaktualizuj ustawienia serwer i udostęnij fukcję CURL', [], 'Modules.Leaselinkpayment.Admin');        }                               }                    public function install()     {           $this->installDB(); 		$this->addNewOrderState();  	 		        try {              return parent::install() && 				// $this->registerHook('displayHeader') &&                  $this->registerHook('displayFooter') &&  				//$this->registerHook('displayLeftColumn')&& 				$this->registerHook('paymentReturn') &&                 $this->registerHook('paymentOptions')  &&                   $this->registerHook('displayProductAdditionalInfo') &&                 $this->registerHook('displayReassurance') &&  				// $this->registerHook('displayProductPriceBlock') &&    				Configuration::updateValue('LEASELINK_URL_BASE',  self::BASEURL_LEASELINK )&&                Configuration::updateValue('LEASELINK_KLIENTID', '000000') &&                Configuration::updateValue('LEASELINK_TESTAPI_ID', '') &&                 Configuration::updateValue('LEASELINK_PRODAPI_ID', '') &&                 Configuration::updateValue('LEASELINK_TESTAPI_SWITCH', 'true') &&                Configuration::updateValue('LEASELINK_CALC_SWITCH', 'true') &&                 Configuration::updateValue('LEASELINK_SIDEUP_SWITCH', 'true') &&                                Configuration::updateValue('LEASELINK_DEBUG', 'true') &&                     Configuration::updateValue('LEASELINK_NEW_STATUS', '') &&                     Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS1', '') &&   				                Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS2', '') &&   				Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS3', '') &&  				Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS4', '') &&  				Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS5', '') &&  				                Configuration::updateValue('LEASELINK_ORDER_INFO_CUSTOM_TEXT', '') &&                                   Configuration::updateValue('LEASELINK_URL_TEST', self::BASEURL_LEASELINK_TEST) ;				  				         } catch (\Exception $e) {            return false;        }                         return true;     }         private function installDB()    {        $sql = "CREATE TABLE IF NOT EXISTS `"._DB_PREFIX_."leaselink_transactions` (        `id` int(10) NOT NULL AUTO_INCREMENT,        `id_cart` int(10) NOT NULL,        `leaselink_id` varchar(50) NOT NULL,        `state` varchar(50) NOT NULL,        `date_add` datetime NOT NULL,        `date_upd` datetime NOT NULL,        `attachements` TEXT NULL DEFAULT NULL,        PRIMARY KEY (`id`),        UNIQUE(`id_cart`),         UNIQUE(`leaselink_id`)        ) ENGINE="._MYSQL_ENGINE_." DEFAULT CHARSET=utf8;";        return Db::getInstance()->execute($sql);    }    public static function setTransation($cart_id, $leaselink_id, $leaselink_status, $attachmentsData = null)    {          $attachments = "NULL";        if (!empty($attachmentsData)) {            $attachments = "'".serialize($attachmentsData)."'";        }        $sql = "INSERT INTO `"._DB_PREFIX_."leaselink_transactions` (`id_cart`, `leaselink_id`, `state`, `date_add`, `date_upd`, `attachements`)        VALUES (".pSQL($cart_id).",'".pSQL($leaselink_id)."','".pSQL($leaselink_status)."',now(),now(),".$attachments.") ON DUPLICATE KEY UPDATE state = VALUES(state), date_upd = VALUES(date_upd), attachements = VALUES(attachements);";        return  Db::getInstance()->execute($sql);    }    public function countTransactions($state = null, $after = null, $before = null)    {        $query = new DbQuery();        $query->select('count(*)');          $query->from('leaselink_transactions', "tr");        if (!empty($state)) {            $query->where("state = '" . pSQL($state) . "'");        }        if (!empty($after) and !empty($before)) {            $query->where("tr.date_add BETWEEN '" . pSQL($after) . "' AND '" . pSQL($before) . "'");        } elseif (!empty($after) and empty($before)) {            $query->where("tr.date_add >= '" . pSQL($after) . "'");        } elseif (empty($after) and !empty($before)) {            $query->where("tr.date_add <= '" . pSQL($before) . "'");        }        return Db::getInstance()->getValue($query);    }    public function getTransactions($page_number = 0, $page_size = 10, $state = null, $after = null, $before = null)    {        $query = new DbQuery();        $query->select("tr.*, o.id_order, o.total_paid_tax_incl as gross, o.total_paid_tax_excl as net, reference");        $query->from("leaselink_transactions", "tr");        $query->leftJoin('orders', 'o', 'o.id_cart = tr.id_cart');        if (!empty($state)) {             $query->where("state = '" . pSQL($state) . "'");        }        if (!empty($after) and !empty($before)) {            $query->where("tr.date_add BETWEEN '" . pSQL($after) . "' AND '" . pSQL($before) . "'");        } elseif (!empty($after) and empty($before)) {            $query->where("tr.date_add >= '" . pSQL($after) . "'");        } elseif (empty($after) and !empty($before)) {            $query->where("tr.date_add <= '" . pSQL($before) . "'");        }        $query->orderBy("tr.date_add");        $query->limit($page_size, $page_number * $page_size);        return Db::getInstance()->ExecuteS($query);    }    public function uninstall()      { 		self::resetAll();  	        $sql = [            "UPDATE " . _DB_PREFIX_ . 'order_state SET `deleted` = 1 WHERE `module_name` = "leaselinkpayment"',        ];        $newStatus = Configuration::get('LEASELINK_NEW_STATUS');        if (!empty($newStatus)) {            $sql[] = "UPDATE " . _DB_PREFIX_ . "order_state SET `deleted` = 1 WHERE id_order_state = " . pSQL(Configuration::get('LEASELINK_NEW_STATUS'));        }        foreach ($sql as $query) {            Db::getInstance()->execute($query);         }                 $languages = Language::getLanguages(false);        foreach ($languages as $lang) {            if (!Configuration::deleteByName('LEASELINK_INFO_CUSTOM_TEXT', $lang['id_lang'])) {                return false;             }         }        if ( !Configuration::deleteByName('LEASELINK_TESTAPI_ID')                || !Configuration::deleteByName('LEASELINK_PRODAPI_ID')                || !Configuration::deleteByName('LEASELINK_KLIENTID')				|| !Configuration::deleteByName('LEASELINK_DEBUG')                || !Configuration::deleteByName('LEASELINK_TESTAPI_SWITCH')                 || !Configuration::deleteByName('LEASELINK_INFO_DETAILS')                || !Configuration::deleteByName('LEASELINK_SIDEUP_SWITCH')                || !Configuration::deleteByName('LEASELINK_CALC_SWITCH')                || !Configuration::deleteByName('LEASELINK_URL_TEST')                   || !Configuration::deleteByName('LEASELINK_NEW_STATUS')                  || !Configuration::deleteByName('LEASELINK_INFO_STARUS_LL_PRZYPIS1')                  || !Configuration::deleteByName('LEASELINK_INFO_STARUS_LL_PRZYPIS2')  				|| !Configuration::deleteByName('LEASELINK_INFO_STARUS_LL_PRZYPIS3') 				|| !Configuration::deleteByName('LEASELINK_INFO_STARUS_LL_PRZYPIS4') 				|| !Configuration::deleteByName('LEASELINK_INFO_STARUS_LL_PRZYPIS5')                  || !Configuration::deleteByName('LEASELINK_ORDER_INFO_CUSTOM_TEXT')				                || !parent::uninstall()) {             return false;        }        return true;    }			public function resetAll()     {        $sql = new DbQuery();        $sql->select('`name`');        $sql->from('configuration');         $sql->where(' `name` LIKE    "LL\\\\_%" OR "LEASELINK\\\\_%" '); //and "LEASELINK\\\\_%"        $leaselinkpayment = Db::getInstance()->executeS($sql->build());         foreach ($leaselinkpayment as $r) {             Configuration::deleteByName($r['name']);        }    }		            public function renderForm()    {                 $comapny_fields_form = [            'form' => [                'legend' => [                    'title' => $this->trans('Rejestracja danych firmy', [], 'Modules.Leaselinkpayment.Admin'),                    'icon' => 'icon-envelope'                ],                'input' => [                     [                         'type' => 'text',                        'label' => $this->trans('Nazwa firmy', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_NAZWA',//'LEASELINK_INFO_OWNER',  //APID                        'required' => true                    ],                    [                        'type' => 'text',                        'label' => $this->trans('NIP', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_NIP',                         'required' => true                    ],                    [                        'type' => 'text',                        'label' => $this->trans('Strona WWW', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_WWW',                         'required' => true                    ],                     [                        'type' => 'text',                        'label' => $this->trans('Ulica', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_STREET',                         'required' => true                    ],                        [                        'type' => 'text',                        'label' => $this->trans('Numer ulicy', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_STREET_NR',                         'required' => true                    ],                       [                        'type' => 'text',                         'label' => $this->trans('Numer lokalu', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_STREET_HOME_NR',                         'required' => true                    ],                                              [                        'type' => 'text',                        'label' => $this->trans('Miasto', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_CITY',                         'required' => true                    ],                                      [                        'type' => 'text',                        'label' => $this->trans('Kod poczty', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_POST_CODE',                         'required' => true                    ],                                      [                        'type' => 'text',                        'label' => $this->trans('Imię osoby reprezentującej', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_USER_NAME',                         'required' => true                    ],                                          [                        'type' => 'text',                        'label' => $this->trans('Nazwisko osoby reprezentującej', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_USER_SURNAME',                         'required' => true                    ],                                                                              [                        'type' => 'text',                        'label' => $this->trans('Telefon', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_USER_PHONE',                         'required' => true                    ],                                          [                        'type' => 'text',                        'label' => $this->trans('E-Mail', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENT_USER_EMAIL',                         'required' => true                    ],                  ],                'submit' => [                    'title' => $this->trans('Wyslij dane rejestracyjne', [], 'Admin.Actions'),                ]            ],        ];                 $oneoption=             [               [                 'id_option' =>   0,                'nameoption' =>    $this->trans('Odbiór w sklepie', [], 'Modules.Leaselinkpayment.Admin')              ],[                 'id_option' =>   1,                'nameoption' => $this->trans('Przesyłka kurierska', [], 'Modules.Leaselinkpayment.Admin')              ],[                 'id_option' =>   2,                'nameoption' =>  $this->trans('Inne', [], 'Modules.Leaselinkpayment.Admin')              ]             ];              $deliveryoptions = Carrier::getCarriers((int)Configuration::get('PS_LANG_DEFAULT'), true, false);        $foreachdelivery = '';        $foreachdeliveryArray =[];		$orderstats = [];		        //statusy zamowien 		$orderStates = OrderState::getOrderStates((int)Context::getContext()->language->id,true);		$optionsStats =[];		$optionsStats[] = [                    'id_option' => '',                 'name' => 'Wybierz'            ] ;          foreach ($orderStates as $status) {			if($status['id_order_state']>0)            $optionsStats[] = [                'id_option' => $status['id_order_state'],                'name' => $status['name']            ] ;         }		 	// Ścieżka do katalogu modułu        $modulePath = _PS_MODULE_DIR_ .'/leaselinkpayment/';        // Ścieżka do pliku w katalogu modułu          $filePath = $modulePath . 'dane_zapisane_callback.log';         // Dane do zapisania        $content = "[" . date('Y-m-d H:i:s') . "] " . print_R($optionsStats, true) . PHP_EOL;        // Zapis danych do pliku        if (file_put_contents($filePath, $content, FILE_APPEND)) { } else { }       				         $fields_form = [            'form' => [                'legend' => [                    'title' => $this->trans('Szczegóły konta', [], 'Modules.Leaselinkpayment.Admin'),                    'icon' => 'icon-envelope'                ],                'input' => [                     [                         'type' => 'text',                        'label' => $this->trans('Identyfikator klienta', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_KLIENTID',//'LEASELINK_INFO_OWNER',  //APID                        'required' => true                    ],                    [                        'type' => 'text',                        'label' => $this->trans('API testowe', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_TESTAPI_ID',                         'required' => true                    ],                    [                        'type' => 'text',                        'label' => $this->trans('API produkcyjne', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_PRODAPI_ID',                         'required' => true                    ],                     [                         'type' => 'switch',                        'label' => $this->trans('Włącz tryb testowy', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_TESTAPI_SWITCH',                        'is_bool' => true,                        'hint' => $this->trans('Włącz tryb testowy', [], 'Modules.Leaselinkpayment.Admin'),                        'values' => [                            [                                 'id' => 'active_on',                                'value' => true,                                'label' => $this->trans('Enabled', [], 'Admin.Global'),                            ],                            [                                'id' => 'active_off',                                'value' => false,                                'label' => $this->trans('Disabled', [], 'Admin.Global'),                            ]                        ],                    ],                           [                        'type' => 'free',                        'label' => $this->trans('FORMY DOSTAWY', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'FORMY_DOSTAWY'                     ],  					],                                 'submit' => [                    'title' => $this->trans('Save', [], 'Admin.Actions'),                ]            ],        ];                			foreach ($deliveryoptions as $carrier) {								$key = "LEASELINK_CARRIER_" . $carrier['id_carrier'];								$deliveryoptionsarr[$key] = Configuration::get($key, false);  			   									$foreachdelivery = [										'type' => 'select',										'label' => $this->trans($carrier['name'] , [], 'Modules.Leaselinkpayment.Admin'),										'name' =>  $key,    										'options'  => [											'query' => $oneoption,											'id' => 'id_option',											'name' => 'nameoption' 										   ],										'required' => true									] ;								 								array_push($fields_form['form']['input'], $foreachdelivery);  			}                $fields_form_customization = [            'form' => [                'legend' => [                    'title' => $this->trans('Ustawienia', [], 'Modules.Leaselinkpayment.Admin'),                    'icon' => 'icon-cogs'                ],                'input' => [                                                         [                         'type' => 'switch',                        'label' => $this->trans('Włącz element SideUp', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_SIDEUP_SWITCH',                        'is_bool' => true,                        'hint' => $this->trans('Włącz na stronie wysówany panel informacyjny', [], 'Modules.Leaselinkpayment.Admin'),                        'values' => [                            [                                'id' => 'active_on',                                'value' => true,                                'label' => $this->trans('Enabled', [], 'Admin.Global'),                            ],                            [                                'id' => 'active_off',                                'value' => false,                                'label' => $this->trans('Disabled', [], 'Admin.Global'),                            ]                         ],                    ],                    [                         'type' => 'switch',                        'label' => $this->trans('Włącz przycisk kalkulatora', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_CALC_SWITCH',                         'is_bool' => true,                         'hint' => $this->trans('Włącz na stronie produktu kalkulator leasingu', [], 'Modules.Leaselinkpayment.Admin'),                        'values' => [                            [                                'id' => 'active_on',                                'value' => true,                                'label' => $this->trans('Enabled', [], 'Admin.Global'),                            ],                            [                                'id' => 'active_off',                                'value' => false,                                'label' => $this->trans('Disabled', [], 'Admin.Global'),                            ]                        ],                    ],                    [                        'type' => 'textarea',                        'label' => $this->trans('Informacje pod przyciskiem', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_INFO_DETAILS',                         'desc' => $this->trans('Dodatkowe informaje wyświetlane pod przyciskiem kalkulatora Leasingowego.', [], 'Modules.Leaselinkpayment.Admin'),                        'lang' => true                    ],                     [                        'type' => 'select',                        'label' => $this->l('Pozycja przycisku kalkulatora na produkcie'),                        'name' => 'LEASELINK_INFO_PRODUCT_POSITION',                        'default_value' => 0,                        'options' => [                            'query' => [                                ['id' => 0, 'name' => $this->l('displayProductAdditionalInfo')],                                ['id' => 1, 'name' => $this->l('displayProductPriceBlock')],                                ['id' => 2, 'name' => $this->l('displayReassurance')],                            ],                            'id' => 'id',                            'name' => 'name',                        ],                    ],                                 [                        'type' => 'switch',                        'label' => $this->trans('Pokaż informacje pod opcją płatnosci', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_ORDER_INFO_CUSTOM_TEXT',                         'is_bool' => true,                        'hint' => $this->trans('Your country\'s legislation may require you to send the invitation to pay by email only. Disabling the option will hide  invitation on confirmation page.', [], 'Modules.Leaselinkpayment.Admin'),                        'values' => [                             [                                'id' => 'active_on',                                'value' => true,                                'label' => $this->trans('Enabled', [], 'Admin.Global'),                            ],                            [                                'id' => 'active_off',                                'value' => false,                                'label' => $this->trans('Disabled', [], 'Admin.Global'),                            ]                         ],                    ],                    [                        'type' => 'textarea',                        'label' => $this->trans('Pokaz informacje na stronie zamówienia', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_INFO_CUSTOM_TEXT',                        'desc' => $this->trans('Dodatkowe informacje przy wyborze rodzaju płatności', [], 'Modules.Leaselinkpayment.Admin'),                        'lang' => true                    ], 	// ['id' => 0, 'name' => Configuration::get('LEASELINK_INFO_STARUS_LL_PRZYPIS1')],                            // ['id' => 1, 'name' => Configuration::get('LEASELINK_INFO_STARUS_LL_PRZYPIS2')],												[										    'type' => 'select',                        'label' => $this->l('Przypisz status transakcji dla oczekiwanie na płatnosć'),                        'name' => 'LEASELINK_INFO_STARUS_LL_PRZYPIS1',                         'options' => [							'query' =>$optionsStats,														'id' => 'id_option',                              'name' => 'name', 							],																],					[					 					    'type' => 'select',                        'label' => $this->l('Przypisz status transakcji dla płatnosci zaakceptowana'),                        'name' => 'LEASELINK_INFO_STARUS_LL_PRZYPIS2',                         'options' => [                            'query' =>$optionsStats,                            'id' => 'id_option',                            'name' => 'name',							], 						             										],	[										    'type' => 'select',                        'label' => $this->l('Przypisz status transakcji dla płatnosci anulowanej'),                        'name' => 'LEASELINK_INFO_STARUS_LL_PRZYPIS3',                        'default_value' => 4,                        'options' => [							'query' =>$optionsStats,														'id' => 'id_option',                              'name' => 'name', 							],																],					                    [                        'type' => 'switch',                        'label' => $this->trans('Tryb techniczny', [], 'Modules.Leaselinkpayment.Admin'),                        'name' => 'LEASELINK_DEBUG',                        'is_bool' => true,                        'hint' => $this->trans('Debug mode', [], 'Modules.Leaselinkpayment.Admin'),                        'values' => [                            [                                'id' => 'active_on',                                'value' => true,                                'label' => $this->trans('Enabled', [], 'Admin.Global'),                            ],                            [                                'id' => 'active_off',                                'value' => false,                                'label' => $this->trans('Disabled', [], 'Admin.Global'),                            ]                         ],                    ],                ],                'submit' => [                    'title' => $this->trans('Save', [], 'Admin.Actions'),                ]            ],        ];                  $helper = new HelperForm();        $helper->show_toolbar = false;        $helper->table = $this->table;                $lang = new Language((int)Configuration::get('PS_LANG_DEFAULT'));                $helper->default_form_language = $lang->id;        $helper->allow_employee_form_lang = Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG') ? : 0;                $this->fields_form = [];        $helper->id = (int)Tools::getValue('id_carrier');        $helper->identifier = $this->identifier;        $helper->submit_action = 'btnSubmit';        $helper->currentIndex = $this->context->link->getAdminLink('AdminModules', false).'&configure='            .$this->name.'&tab_module='.$this->tab.'&module_name='.$this->name;        $helper->token = Tools::getAdminTokenLite('AdminModules');                        $helper->tpl_vars = [             'fields_value' => $this->getConfigFieldsValues(),            'languages' => $this->context->controller->getLanguages(),            'id_language' => $this->context->language->id        ];        return $helper->generateForm([$fields_form, $fields_form_customization]);    }        public function getConfigFieldsValues() //OK    {        $custom_text = [];        $button_aditional_text = [];         $custom_carrier = [];        $custom_order_text = [];        $languages = Language::getLanguages(false);        foreach ($languages as $lang) {             $button_aditional_text[$lang['id_lang']] = Tools::getValue(                'LEASELINK_INFO_DETAILS_'.$lang['id_lang'],                  Configuration::get('LEASELINK_INFO_DETAILS', $lang['id_lang'])            );                      $custom_text[$lang['id_lang']] = Tools::getValue(                'LEASELINK_INFO_CUSTOM_TEXT_'.$lang['id_lang'],                Configuration::get('LEASELINK_INFO_CUSTOM_TEXT', $lang['id_lang'])            );                        }                $data =[];               $carriers = Carrier::getCarriers((int)Configuration::get('PS_LANG_DEFAULT'), true, false);                $this->context->smarty->assign("carriers", $carriers);          $dataNew= [];        foreach ($carriers as $carrier) {              $key = "LEASELINK_CARRIER_" . $carrier['id_carrier'];              Configuration::updateValue( $key , Tools::getValue($key, Configuration::get($key))) ; 			            $values[$key] = Configuration::get($key, false);             $dataNewN = [  $key=>Tools::getValue($key, Configuration::get($key)) ];            $dataNew  = $dataNew + $dataNewN;          }                         $data  = [                  'LEASELINK_KLIENTID' => Tools::getValue('LEASELINK_KLIENTID', Configuration::get('LEASELINK_KLIENTID')),            'LEASELINK_TESTAPI_ID' => Tools::getValue('LEASELINK_TESTAPI_ID', Configuration::get('LEASELINK_TESTAPI_ID')),            'LEASELINK_PRODAPI_ID' => Tools::getValue('LEASELINK_PRODAPI_ID', Configuration::get('LEASELINK_PRODAPI_ID')),            'LEASELINK_DEBUG'=> Tools::getValue('LEASELINK_DEBUG', Configuration::get('LEASELINK_DEBUG')),            'LEASELINK_SEND_CATEGORY'=> '',            'FORMY_DOSTAWY'=>'',                        'LEASELINK_TESTAPI_SWITCH' => Tools::getValue('LEASELINK_TESTAPI_SWITCH', Configuration::get('LEASELINK_TESTAPI_SWITCH')),            'LEASELINK_SIDEUP_SWITCH' => Tools::getValue('LEASELINK_SIDEUP_SWITCH', Configuration::get('LEASELINK_SIDEUP_SWITCH')),            'LEASELINK_CALC_SWITCH' => Tools::getValue('LEASELINK_CALC_SWITCH', Configuration::get('LEASELINK_CALC_SWITCH')),            'LEASELINK_ORDER_INFO_CUSTOM_TEXT' => Tools::getValue('LEASELINK_ORDER_INFO_CUSTOM_TEXT', Configuration::get('LEASELINK_ORDER_INFO_CUSTOM_TEXT')),            'LEASELINK_INFO_PRODUCT_POSITION' => Tools::getValue('LEASELINK_INFO_PRODUCT_POSITION', Configuration::get('LEASELINK_INFO_PRODUCT_POSITION')),            'LEASELINK_INFO_STARUS_LL_PRZYPIS1' => Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS1', Configuration::get('LEASELINK_INFO_STARUS_LL_PRZYPIS1')),            'LEASELINK_INFO_STARUS_LL_PRZYPIS2' => Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS2', Configuration::get('LEASELINK_INFO_STARUS_LL_PRZYPIS2')),            'LEASELINK_INFO_STARUS_LL_PRZYPIS3' => Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS3', Configuration::get('LEASELINK_INFO_STARUS_LL_PRZYPIS3')),            'LEASELINK_INFO_STARUS_LL_PRZYPIS4' => Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS4', Configuration::get('LEASELINK_INFO_STARUS_LL_PRZYPIS4')),            'LEASELINK_INFO_STARUS_LL_PRZYPIS5' => Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS5', Configuration::get('LEASELINK_INFO_STARUS_LL_PRZYPIS5')),			            'LEASELINK_INFO_DETAILS' => $button_aditional_text,             'LEASELINK_INFO_CUSTOM_TEXT' => $custom_text,              'LEASELINK_KLIENT_NAZWA' => Tools::getValue('LEASELINK_KLIENT_NAZWA', Configuration::get('LEASELINK_KLIENT_NAZWA')),            'LEASELINK_KLIENT_NIP' => Tools::getValue('LEASELINK_KLIENT_NIP', Configuration::get('LEASELINK_KLIENT_NIP')),            'LEASELINK_KLIENT_WWW' => Tools::getValue('LEASELINK_KLIENT_WWW', Configuration::get('LEASELINK_KLIENT_WWW')),            'LEASELINK_KLIENT_STREET' => Tools::getValue('LEASELINK_KLIENT_STREET', Configuration::get('LEASELINK_KLIENT_STREET')),            'LEASELINK_KLIENT_STREET_NR' => Tools::getValue('LEASELINK_KLIENT_STREET_NR', Configuration::get('LEASELINK_KLIENT_STREET_NR')),            'LEASELINK_KLIENT_STREET_HOME_NR' => Tools::getValue('LEASELINK_KLIENT_STREET_HOME_NR', Configuration::get('LEASELINK_KLIENT_STREET_HOME_NR')),            'LEASELINK_KLIENT_CITY' => Tools::getValue('LEASELINK_KLIENT_CITY', Configuration::get('LEASELINK_KLIENT_CITY')),            'LEASELINK_KLIENT_POST_CODE' => Tools::getValue('LEASELINK_KLIENT_POST_CODE', Configuration::get('LEASELINK_KLIENT_POST_CODE')),            'LEASELINK_KLIENT_USER_NAME' => Tools::getValue('LEASELINK_KLIENT_USER_NAME', Configuration::get('LEASELINK_KLIENT_USER_NAME')),            'LEASELINK_KLIENT_USER_SURNAME' => Tools::getValue('LEASELINK_KLIENT_USER_SURNAME', Configuration::get('LEASELINK_KLIENT_USER_SURNAME')),            'LEASELINK_KLIENT_USER_PHONE' => Tools::getValue('LEASELINK_KLIENT_USER_PHONE', Configuration::get('LEASELINK_KLIENT_USER_PHONE')),            'LEASELINK_KLIENT_USER_EMAIL' => Tools::getValue('LEASELINK_KLIENT_USER_EMAIL', Configuration::get('LEASELINK_KLIENT_USER_EMAIL')),                     ];                 $data = $dataNew + $data;                   return $data;       }          public function hookdisplayAfterProductThumbs($params)     {       //return $this->displayLeaselinkCalc($params);      }     public function hookdisplayProductPriceBlock($params)     {                 $config = Configuration::get('LEASELINK_INFO_PRODUCT_POSITION');        $controller = Dispatcher::getInstance()->getController();        if ($config == 1 && $controller == 'product' && $params['type'] == 'after_price') {            return $this->displayLeaselinkCalc($params);            }     }       public function hookDisplayProductButtons($params)     {          //return $this->displayLeaselinkCalc($params);      }         public function hookDisplayProductAdditionalInfo($params)    {        $config = Configuration::get('LEASELINK_INFO_PRODUCT_POSITION');        if ($config == 0) {            return $this->displayLeaselinkCalc($params);         }    }     public function hookDisplayReassurance($params)    {         $config = Configuration::get('LEASELINK_INFO_PRODUCT_POSITION');        if ($config == 2) {            return $this->displayLeaselinkCalc($params);          }    }           public function displayLeaselinkCalc()      {         global $smarty;        $id_product = Tools::getValue('id_product');				if($id_product<0) return;		// Language id		$lang_id = (int) Configuration::get('PS_LANG_DEFAULT');;        // $product = new Product($id_product, true);		 		$product = new Product($id_product, false, $lang_id);         $gros = $product->getPriceStatic((int)$id_product,true,null,2);         $net = $product->getPriceStatic((int)$id_product,false,null,2);		          $cat = @$product->getParentCategories();          if (!empty($cat[2])) {  $catLvl2 = $catLvl1 = $cat[2]['name'];   }else { $catLvl1 = 'Other';  }         if (!empty($cat[3])) {  $catLvl2 =  $cat[3]['name'];   } else { $catLvl2 = 'Other';  } 		// echo "<pre>";          // print_r($product);                $lang = new Language((int)Configuration::get('PS_LANG_DEFAULT'));                 if(Configuration::get('LEASELINK_TESTAPI_SWITCH')==true) { $testoption = 1 ;}else{ $testoption = 0 ;}            $smarty->assign([             'item' => [                    "TaxCode" => $product->tax_rate,                    "Tax" => $product->tax_rate,                     "Quantity" => 1,                    "Name" =>  urlencode($product->name ),                      "CategoryLevel1" => $catLvl1,                     "CategoryLevel2" => $catLvl2,                    "NetPrice" => round($net,2),                       "NetValue" => round($net,2),                      "GrossValue" => round($gros,2),                     "TaxValue" => round($gros - $net,2)                ],            'LEASELINK_KLIENTID' => Configuration::get('LEASELINK_KLIENTID'),            'PRODUCT_VAT' => $product->tax_rate,            'LEASELINK_CALC_SWITCH'=> Configuration::get('LEASELINK_CALC_SWITCH'),            'LEASELINK_INFO_DETAILS'=> Configuration::get('LEASELINK_INFO_DETAILS', $lang->id ),             'LEASELINK_INFO_CUSTOM_TEXT'=> Configuration::get('LEASELINK_INFO_CUSTOM_TEXT', $lang->id),                         'LEASELINK_TEST'=> $testoption, 			'LEASELINK_CAT1'=> $catLvl1,			'LEASELINK_CAT2'=> $catLvl2,             'BASEURL_LEASELINK' => Configuration::get('BASEURL_LEASELINK')        ]);             $uid = Configuration::get('LEASELINK_KLIENTID');                // $filenamelink = 'https://rep.leaselink.pl/plugin/'.$uid.'_ps.js';                // if (!$this->url_exists($filenamelink)){        //    if (Configuration::get('LEASELINK_CALC_SWITCH') <> null ) {            //          if($gros>=20 && $net<=100000)  {                        return $this->display(__FILE__, 'product_Calc.tpl');         //           }          //   }         // }     }          public function getContent()//OK dla info w adminie naglowek     {        if (Tools::isSubmit('btnSubmit')) {            $this->_postValidation();            if (!count($this->_postErrors)) {                $this->_postProcess();            } else {                foreach ($this->_postErrors as $err) {                    $this->_html .= $this->displayError($err);                }            }        } else {            $this->_html .= '<br />';        }        $this->_html .= $this->display(__FILE__, 'infos.tpl');         $this->_html .= $this->renderForm();        return $this->_html;    }         protected function _postProcess()     {           $doUpdate = false;        if (Tools::isSubmit('LEASELINK_SEND_CATEGORY')) {            $isUpdate = Tools::getValue('LEASELINK_SEND_CATEGORY');            $doUpdate = !empty($isUpdate);        }                  if ($doUpdate) {              $values = $this->getRegisterFormValues();                            $params = [];            foreach ($values as $key => $value) {                 $params['{'.$key.'}'] =  Configuration::get($key);             }              $lang = (int)Context::getContext()->language->id;            $cats = Category::getCategories($lang, true, false);                       $params['{LEASELINK_REG_CALLBACK_URL}'] = $this->context->link->getModuleLink('leaselinkpayment', 'callback', ['ajax' => '1']);                        //Mail::Send((int)$lang, 'registration', Mail::l('Update categories PrestaShop', (int)$lang), $params, self::EMAIL_LEASELINK, "LeaseLink", null, null, null, null, $this->local_path . 'mails/');           // $this->output .= $this->showConfirmation($this->l('Shop Categories Update Sent successfully'));                                 }elseif (Tools::isSubmit('submitRegisterLeaselinkModule')) {             $values = $this->getRegisterFormValues();                         // print_R($values );             foreach (array_keys($values) as $key) {                $params['{'.$key.'}'] = trim(Tools::getValue($key));            }            $isValid = true;                           $params = [];            foreach ($values as $key => $value) {                $params[ $key ] = $value;                 Configuration::updateValue($key, $value);            }                     Configuration::updateValue('LEASELINK_REG_SENT', $isValid);        }        if (Tools::isSubmit('btnSubmit')) {             Configuration::updateValue('LEASELINK_DEBUG', Tools::getValue('LEASELINK_DEBUG'));            Configuration::updateValue('LEASELINK_KLIENTID', Tools::getValue('LEASELINK_KLIENTID'));            Configuration::updateValue('LEASELINK_TESTAPI_ID', Tools::getValue('LEASELINK_TESTAPI_ID'));            Configuration::updateValue('LEASELINK_PRODAPI_ID', Tools::getValue('LEASELINK_PRODAPI_ID'));             Configuration::updateValue('LEASELINK_TESTAPI_SWITCH', Tools::getValue('LEASELINK_TESTAPI_SWITCH'));             Configuration::updateValue('LEASELINK_SIDEUP_SWITCH', Tools::getValue('LEASELINK_SIDEUP_SWITCH'));            Configuration::updateValue('LEASELINK_CALC_SWITCH', Tools::getValue('LEASELINK_CALC_SWITCH'));             Configuration::updateValue('LEASELINK_INFO_DETAILS', Tools::getValue('LEASELINK_INFO_DETAILS'));             Configuration::updateValue('LEASELINK_INFO_ADDRESS', Tools::getValue('LEASELINK_INFO_ADDRESS'));             Configuration::updateValue('LEASELINK_KLIENT_NAZWA', Tools::getValue('LEASELINK_KLIENT_NAZWA'));            Configuration::updateValue('LEASELINK_KLIENT_NIP', Tools::getValue('LEASELINK_KLIENT_NIP'));            Configuration::updateValue('LEASELINK_KLIENT_WWW' , Tools::getValue('LEASELINK_KLIENT_WWW'));            Configuration::updateValue('LEASELINK_KLIENT_STREET' , Tools::getValue('LEASELINK_KLIENT_STREET'));            Configuration::updateValue('LEASELINK_KLIENT_STREET_NR', Tools::getValue('LEASELINK_KLIENT_STREET_NR'));            Configuration::updateValue('LEASELINK_KLIENT_STREET_HOME_NR', Tools::getValue('LEASELINK_KLIENT_STREET_HOME_NR'));            Configuration::updateValue('LEASELINK_KLIENT_CITY' ,Tools::getValue('LEASELINK_KLIENT_CITY'));            Configuration::updateValue('LEASELINK_KLIENT_POST_CODE', Tools::getValue('LEASELINK_KLIENT_POST_CODE'));            Configuration::updateValue('LEASELINK_KLIENT_USER_NAME' , Tools::getValue('LEASELINK_KLIENT_USER_NAME'));            Configuration::updateValue('LEASELINK_KLIENT_USER_SURNAME', Tools::getValue('LEASELINK_KLIENT_USER_SURNAME'));            Configuration::updateValue('LEASELINK_KLIENT_USER_PHONE' , Tools::getValue('LEASELINK_KLIENT_USER_PHONE'));            Configuration::updateValue('LEASELINK_KLIENT_USER_EMAIL' , Tools::getValue('LEASELINK_KLIENT_USER_EMAIL'));            Configuration::updateValue('LEASELINK_ORDER_INFO_CUSTOM_TEXT', Tools::getValue('LEASELINK_ORDER_INFO_CUSTOM_TEXT'));            Configuration::updateValue('LEASELINK_INFO_PRODUCT_POSITION', Tools::getValue('LEASELINK_INFO_PRODUCT_POSITION'));            Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS1', Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS1'));            Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS2', Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS2'));            Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS3', Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS3'));            Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS4', Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS4'));            Configuration::updateValue('LEASELINK_INFO_STARUS_LL_PRZYPIS5', Tools::getValue('LEASELINK_INFO_STARUS_LL_PRZYPIS5'));												            $this->updateBaseUrl(Tools::getValue('LEASELINK_TESTAPI_SWITCH'));                        $custom_text = [];            $custom_order_text = [];            $languages = Language::getLanguages(false);            foreach ($languages as $lang) {                if (Tools::getIsset('LEASELINK_INFO_CUSTOM_TEXT_'.$lang['id_lang'])) {                    $custom_text[$lang['id_lang']] = Tools::getValue('LEASELINK_INFO_CUSTOM_TEXT_'.$lang['id_lang'], Configuration::get('LEASELINK_INFO_CUSTOM_TEXT_', $lang['id_lang']));                }                //!!!!!!!!!!  dodałm końcowwek                  // if (Tools::getIsset('LEASELINK_ORDER_INFO_CUSTOM_TEXT_'.$lang['id_lang'])) {                    // $custom_order_text[$lang['id_lang']] = Tools::getValue('LEASELINK_ORDER_INFO_CUSTOM_TEXT_'.$lang['id_lang'], Configuration::get('LEASELINK_ORDER_INFO_CUSTOM_TEXT_', $lang['id_lang']));                // }                         if (Tools::getIsset('LEASELINK_INFO_DETAILS_'.$lang['id_lang'])) {                    $custom_info_details_text[$lang['id_lang']] = Tools::getValue('LEASELINK_INFO_DETAILS_'.$lang['id_lang'], Configuration::get('LEASELINK_INFO_DETAILS_', $lang['id_lang']));                }                                 if (Tools::getIsset('LEASELINK_CARRIER_'.$lang['id_lang'])) {                    $custom_carrier_text[$lang['id_lang']] = Tools::getValue('LEASELINK_CARRIER_'.$lang['id_lang'], Configuration::get('LEASELINK_CARRIER_', $lang['id_lang']));                }                             }            Configuration::updateValue('LEASELINK_INFO_CUSTOM_TEXT', $custom_text);            Configuration::updateValue('LEASELINK_INFO_DETAILS', $custom_info_details_text);                             }            $this->_html .= $this->displayConfirmation($this->trans('Ustawienia zaktualizowane'  , [], 'Admin.Global'));    }                    /*    dodwanie pøatnosci do checkout site    */    public function hookPaymentOptions($params)    {        $payment_options="";        $this->showErrors = false;         if (!$this->active) {            return;            }        if (!$this->checkCurrency($params['cart'])) {            return;        }                 $lang = new Language( (int)$this->context->language->id );                 if ($params['cart']->getOrderTotal() <= 20) return ;                     $cart = $params['cart'];        $products= $cart->getProducts(true);            		$configuration = [			"API_KEY" => empty($this->isTest)? Configuration::get('LEASELINK_PRODAPI_ID') : Configuration::get('LEASELINK_TESTAPI_ID'), 			"URL_BASE" =>  empty($this->isTest)? Configuration::get('LEASELINK_URL_BASE') : Configuration::get('LEASELINK_URL_TEST'), //"https://online.leaselink.pl/offerrequest/confirmstatus",			"DEBUG" => false,		];   		           $LeaseLinkApi = new LeaseLinkApi( $configuration  ); 		$myAPI = empty($this->isTest)? Configuration::get('LEASELINK_PRODAPI_ID') : Configuration::get('LEASELINK_TESTAPI_ID');        $reg = $LeaseLinkApi->apiCall('/api/RegisterPartnerSite', [                'ApiKey' => $myAPI            ]);						        // return json_decode(Tools::file_get_contents(Configuration::get('LEASELINK_URL_BASE') .$uri, false, $http_context));		// $this->zapisDoPlikuWModul('916aaasdfas RegisterPartnerSite czy zapisano:'.print_r($reg->Result).'   -====---'.Configuration::get('LEASELINK_URL_BASE')  ); 			             if (empty($reg->Result)) {                $LeaseLinkApi->debugLog("empty(reg->Result)");                return;            }               $customer = new Customer($cart->id_customer);                    $address = new Address($cart->id_address_invoice);             // LeaseLinkApi::debugLog($address->vat_number);            if (empty($address->vat_number)) {                 $address->vat_number = "0000000000";             }else {                                $vatOk = $this->CheckNIP($address->vat_number);                if($vatOk!=1)  $this->showErrors[] = $this->trans('- błędny numer NIP - prosimy o poprawienie pola.', [], 'Modules.Leaselinkpayment.Admin');                                }            $phone = $address->phone_mobile;                        if (empty($phone)) {                             $phone = $address->phone;                               $phoneOk = $this->CheckTEL($address->phone);                                 if($phoneOk!=true)  $this->showErrors[] = $this->trans('- błędny numer telefonu - prosimy o poprawienie pola.', [], 'Modules.Leaselinkpayment.Admin');                            }   else{                     $phoneOk = $this->CheckTEL($address->phone_mobile);                  if($phoneOk!=true)  $this->showErrors[] = $this->trans('- błędny numer telefonu - prosimy o poprawienie pola.', [], 'Modules.Leaselinkpayment.Admin');                                    }                     $order = [                "SaveDataEmail" => $customer->email,                "SaveDataPhone" => $phone,                "TypeOfDelivery" => 1,//Configuration::get("LEASELINK_CARRIER_" .$cart->id_carrier),                "CustomerExternalDocument" => $cart->id,                "Requestors" => [[                     "IdentificationNumber1" => $address->vat_number,                    "RequestorName" => $address->company                ]],                "RequestItems" => [],                 'FullRecalculation'=>'true',                'SaveInProcess'=>'false',//'false',                 "ClientGoBackUrl" => $this->context->link->getModuleLink('leaselinkpayment', 'order', ['control' => $cart->id, 'status' => 'OK'], false),                'Simulation'=>'true'            ];                                foreach ($products  as $product) {                             $product_obj = new Product($product['id_product']);                 $cat = $product_obj->getParentCategories();          			$catLvl1 = $catLvl2 = $catLvl3 = '';                if (!empty($cat[2])) {                      $catLvl1 = $cat[2]['name'];                 }                if (!empty($cat[3])) {                     $catLvl2 = $cat[3]['name'];                 } 				if (!empty($cat[4])) {                     $catLvl3 = $cat[4]['name'];                  }                                  array_push($order["RequestItems"], [                    "TaxCode" => $product["rate"],                    "Tax" => $product["rate"],                    "Quantity" => $product["cart_quantity"],                    "Name" =>  urlencode($product["name"]),                    "CategoryLevel1" => $catLvl1,                    "CategoryLevel2" => $catLvl2,					"CategoryLevel3" => $catLvl3,                     "NetPrice" =>  round($product["price"],2),                     "NetValue" => round($product["total"],2),                    "GrossPrice" => round($product["total_wt"],2),                    "GrossValue" => round($product["total_wt"],2),                    "TaxValue" => $product["total_wt"] - $product["total"]                ]);                              }                         $res = $LeaseLinkApi->apiCall('/api/OfferForClient', $order, $reg->Result->Token);     			             if(isset($res->Result)){                 $this->smarty->assign([                          'module_dir' => $this->_path,                          'message' => $this->showErrors,                        'totalOrderC' => Tools::displayPrice($params['cart']->getOrderTotal(true, Cart::BOTH)),                        'shopId' => Configuration::get('LEASELINK_KLIENTID'),                        'symulatorURL' => Configuration::get('LEASELINK_URL_BASE'),                        'totalOrder' => $params['cart']->getOrderTotal(),                         'LEASELINK_INFO_CUSTOM_TEXT'=> Configuration::get('LEASELINK_INFO_CUSTOM_TEXT', $lang->id),                                              'LEASELINK_ORDER_INFO_CUSTOM_TEXT'=> Configuration::get('LEASELINK_ORDER_INFO_CUSTOM_TEXT'),                        'propozycjaCenowaLeasingu' => $res->Result->OfferItems[0]->MonthlyRateNetValue,                        'imgDir' => $this->_path . 'images'                     ]);                                                                       $newOption = new PaymentOption();                $newOption->setModuleName($this->name)                         ->setCallToActionText($this->trans('Weź w leasingu', [], 'Modules.Leaselinkpayment.Shop'))                         ->setAction($this->context->link->getModuleLink('leaselinkpayment', 'validationLeasing', [], true))                            ->setAdditionalInformation($this->fetch('module:leaselinkpayment/views/templates/front/leaselinkpayment_intro.tpl'));                                         $payment_options = [                    $newOption,                ];                                     }else{                if(Configuration::get("LEASELINK_DEBUG")==1){                    echo "<pre>";                    print_r($res);                    echo "</pre>";                    echo "<pre>";                     print_R( $order);                    echo "</pre>";                                  }                            }                         return $payment_options;    }             protected function updateBaseUrl($isTest = false)  // OK    {        Configuration::updateValue('LEASELINK_URL_BASE', $isTest ? self::BASEURL_LEASELINK_TEST : self::BASEURL_LEASELINK);    }          public function hookDisplayFooter($params) //OK    {         $this->smarty->assign([            'module_dir' => $this->_path,               'LEASELINK_SIDEUP_SWITCH' => Configuration::get('LEASELINK_SIDEUP_SWITCH'),            'LEASELINK_KLIENTID' => Configuration::get('LEASELINK_KLIENTID'),            'LEASELINK_URL_BASE' => Configuration::get('LEASELINK_URL_BASE'),            'LEASELINK_TESTAPI_SWITCH' => Configuration::get("LEASELINK_TESTAPI_SWITCH")        ]);                  return $this->display(__FILE__, 'sideUp.tpl');     }             public function hookDisplayFooterBefore($params) //OK      {      } 	        protected function _postValidation()    {        if (Tools::isSubmit('btnSubmit')) {                          if (!Tools::getValue('LEASELINK_PRODAPI_ID')) {                $this->_postErrors[] = $this->trans('Account production API ID are required.', [], 'Modules.Leaselinkpayment.Admin');            }                         if (!Tools::getValue('LEASELINK_KLIENTID')) {               $this->_postErrors[] = $this->trans('Account identifier is required.', [], "Modules.Leaselinkpayment.Admin");            }        }    }         /**     * Set values for the inputs. LEASELINK_DEBUG     */    protected function getRegisterFormValues()     {        return [            'LEASELINK_KLIENT_NAZWA' => Configuration::get('LEASELINK_KLIENT_NAZWA'),            'LEASELINK_KLIENT_NIP' => Configuration::get('LEASELINK_KLIENT_NIP'),            'LEASELINK_KLIENT_WWW'=> Configuration::get('LEASELINK_KLIENT_WWW'),            'LEASELINK_KLIENT_STREET' => Configuration::get('LEASELINK_KLIENT_STREET'),            'LEASELINK_KLIENT_STREET_NR' => Configuration::get('LEASELINK_KLIENT_STREET_NR'),            'LEASELINK_KLIENT_STREET_HOME_NR' => Configuration::get('LEASELINK_KLIENT_STREET_HOME_NR'),            'LEASELINK_KLIENT_POST_CODE' => Configuration::get('LEASELINK_KLIENT_POST_CODE'),            'LEASELINK_KLIENT_CITY' => Configuration::get('LEASELINK_KLIENT_CITY'),            'LEASELINK_KLIENT_USER_NAME' => Configuration::get('LEASELINK_KLIENT_USER_NAME'),            'LEASELINK_KLIENT_USER_SURNAME' => Configuration::get('LEASELINK_KLIENT_USER_SURNAME'),            'LEASELINK_KLIENT_USER_PHONE' => Configuration::get('LEASELINK_KLIENT_USER_PHONE'),            'LEASELINK_KLIENT_USER_EMAIL' => Configuration::get('LEASELINK_KLIENT_USER_EMAIL'),        ];     }    public function showError($error)    {        if (method_exists(__CLASS__, 'displayError')) {            return $this->displayError($error);        }        $output = '        <div class="bootstrap">        <div class="module_error alert alert-danger" >            <button type="button" class="close" data-dismiss="alert">&times;</button>';        if (is_array($error)) {            $output .= '<ul>';            foreach ($error as $msg) {                $output .= '<li>'.$msg.'</li>';            }            $output .= '</ul>';        } else {            $output .= $error;        }        // Close div openned previously        $output .= '</div></div>';        $this->error = true;        return $output;    }    public function showWarning($warning)    {        if (method_exists(__CLASS__, 'displayWarning')) {            return $this->displayWarning($warning);        }        $output = '        <div class="bootstrap">        <div class="module_warning alert alert-warning" >            <button type="button" class="close" data-dismiss="alert">&times;</button>';        if (is_array($warning)) {            $output .= '<ul>';            foreach ($warning as $msg) {                $output .= '<li>'.$msg.'</li>';            }            $output .= '</ul>';        } else {            $output .= $warning;        }         $output .= '</div></div>';        return $output;    }               public function showConfirmation($string)    {        if (method_exists(__CLASS__, 'displayConfirmation')) {            return $this->displayConfirmation($string);        }        $output = '        <div class="bootstrap">        <div class="module_confirmation conf confirm alert alert-success">            <button type="button" class="close" data-dismiss="alert">&times;</button>            '.$string.'        </div>        </div>';        return $output;    }            public function hookPaymentReturn($params)     {                    global $cart, $cookie, $currency;           if (!$this->active) {                return;            }            $customer = new Customer($params['objOrder']->id_customer);            if (!Validate::isLoadedObject($customer)) {                return;            }            if ((bool)Context::getContext()->customer->is_guest) {                $form_url=$this->context->link->getPageLink('guest-tracking', true);            } else {                $form_url=$this->context->link->getPageLink('history', true);            }            $param = [                'order_reference' => $params['objOrder']->reference,                'email' => $customer->email,                'submitGuestTracking' => 1            ];            $this->smarty->assign([                'params' => $param,                'module_dir' => $this->getPathUri(),                  'form_url' => $form_url,            ]);            return $this->display(__FILE__, 'payment_return.tpl');      }            public function checkCurrency($cart)  //OK     {        $currency_order = new Currency($cart->id_currency);        $currencies_module = $this->getCurrency($cart->id_currency);        if (is_array($currencies_module)) {            foreach ($currencies_module as $currency_module) {                if ($currency_order->id == $currency_module['id_currency']) {                    return true;                }            }        }        return false;    }             private function copyStatusImage($source, $dest)    {        $target = mydirname($this->local_path, 3);        return copy($this->local_path.'/views/img/'.$source.'.gif', $target.'/img/os/'.$dest.'.gif');    }         /**     * Add the CSS & JavaScript files you want to be added on the Front Office.     */    public function hookDisplayHeader()    {        $this->context->controller->registerJavascript(            'jquery-transit',            'modules/'.$this->name.'/views/js/jquery.transit.js',            [                 'position' => 'bottom',                'priority' => 5            ]         );               $this->context->controller->addCSS('modules/'.$this->name.'/views/css/front.css');                $uid = Configuration::get('LEASELINK_KLIENTID');                $filenamelink = 'https://rep.leaselink.pl/plugin/'.$uid.'_ps.js';                 if ($this->url_exists($filenamelink)) {              $this->context->controller->registerJavascript('cdn', 'https://rep.leaselink.pl/plugin/'.$uid.'_ps.js', ['media' => 'all', 'priority' => 10, 'inline' => true, 'server' => 'remote']);                              }      }	           function CheckNIP($str) {        $str = preg_replace('/[^0-9]+/', '', $str);             if (strlen($str) !== 10) {            return false;        }             $arrSteps = [6, 5, 7, 2, 3, 4, 5, 6, 7];        $intSum = 0;             for ($i = 0; $i < 9; $i++) {            $intSum += $arrSteps[$i] * $str[$i];        }             $int = $intSum % 11;        $intControlNr = $int === 10 ? 0 : $int;               if ($intControlNr == $str[9]) {             return true;         }             return false;    }            function CheckTEL($str) {        $str = preg_replace('/[^0-9]+/', '', $str);        if(strlen($str)>=9) return true;                return false;    }       function url_exists($url) {        $handle   = curl_init($url);        curl_setopt($handle, CURLOPT_HEADER, false);        curl_setopt($handle, CURLOPT_FAILONERROR, true);        curl_setopt($handle, CURLOPT_NOBODY, true);        curl_setopt($handle, CURLOPT_RETURNTRANSFER, false);        $connectable = curl_exec($handle);        curl_close($handle);           return $connectable;    }				 												  private static $statusColor = [        0 => 'Lightblue',        1 => 'Limegreen',        2 => 'blue',        3 => 'yellow',        4 => 'black',    ];     private static $statusTemplate = [         0 => '',        1 => 'payment',        2 => '',        3 => '',         4 => '',      ];            private static $status = [            0 => ['statusKey' => 0, 'number' => 1, 'colorKey' => 0, 'paid' => 0, 'invoice' => 0, 'templateKey' => 0],        1 => ['statusKey' => 1, 'number' => 2, 'colorKey' => 1, 'paid' => 1, 'invoice' => 1, 'templateKey' => 1],         2 => ['statusKey' => 2, 'number' => 3, 'colorKey' => 2, 'paid' => 0, 'invoice' => 0, 'templateKey' => 2],        3 => ['statusKey' => 3, 'number' => 4, 'colorKey' => 3, 'paid' => 0, 'invoice' => 0, 'templateKey' => 3],        4 => ['statusKey' => 4, 'number' => 5, 'colorKey' => 4, 'paid' => 0, 'invoice' => 0, 'templateKey' => 4],    ];  	private static $langstat = [           'pl' => [            0 => 'LeaseLink - oczekiwanie na płatność',            1 => 'Leaselink - płatność przyjęta',			2 => 'Leaselink - umowa podpisana - wyślij FV',			3 => 'Leaselink - etap skladania wniosku',			4 => 'Leaselink - płatność anulowana',        ],         'en' => [            0 => 'Waiting for payment Leaselink',            1 => 'The payment Leaselink has been accepted',						2 => 'Leaselink contract signed - send invoice',  			3 => 'Leaselink - application submission stage',			4 => 'Leaselink - payment canceled ',        ],     ];     public static function addNewOrderState()    { 		          foreach (self::$status as $statusKey) {            $title = self::getArrayLangByStatusKey((int) $statusKey['statusKey']);            $template = self::getArrayTemplateStatusKey((int) $statusKey['statusKey']);            $number = (int) $statusKey['number'];            $color = self::$statusColor[(int) $statusKey['colorKey']];            $paid = (int) $statusKey['paid'];            $invoice = (int) $statusKey['invoice'];            $sql = new DbQuery();            $sql->select('id_order_state');             $sql->from('order_state');              $sql->where('paid = ' . $paid . ' AND invoice = ' . $invoice . ' AND module_name = \'leaselink\'');            $orderStateExists = Db::getInstance()->getRow($sql->build());            if ($orderStateExists) {                $stateId = (int) $orderStateExists['id_order_state'];            } else {                $orderState = new OrderState();                  $orderState->name = $title;                $orderState->template = $template;                $orderState->unremovable = 1;                $orderState->color = $color;                $orderState->paid = $paid;                $orderState->invoice = $invoice;                $orderState->module_name = 'leaselinkpayment';                $orderState->add();                $stateId = (int) $orderState->id;            }             Configuration::updateValue('LL_ORDER_STATE_' . $number, $stateId);        }	     }	 	 		private static function getArrayLangByStatusKey($statusKey)    {        $return = [];        $langTable = Language::getLanguages(false, false);        $arrayLang = self::$langstat;        foreach ($langTable as $langRow) {			            if (array_key_exists($langRow['iso_code'], $arrayLang)) {                $return[$langRow['id_lang']] = $arrayLang[$langRow['iso_code']][$statusKey];            } else {                $return[$langRow['id_lang']] = $arrayLang['en'][$statusKey];            }			        }        return $return;    }		 	private static function getArrayTemplateStatusKey($statusKey)    {        $return = [];        $langTable = Language::getLanguages(false, false);        $arrayStatusTemplate = self::$statusTemplate;         foreach ($langTable as $langRow) {             $return[$langRow['id_lang']] = $arrayStatusTemplate[$statusKey];        }        return $return;    }				// tylko do testów	 public function zapisDoPlikuWModul($datadd, $urle='' )    {        // Ścieżka do katalogu modułu        $modulePath = _PS_MODULE_DIR_ . $this->name . '/';        // Ścieżka do pliku w katalogu modułu        $filePath = $modulePath . 'dane_zapisane'.$urle.'.log';        // Dane do zapisania        $content = "[" . date('Y-m-d H:i:s') . "] " . $datadd . PHP_EOL;        // Zapis danych do pliku        if (file_put_contents($filePath, $content, FILE_APPEND)) {            return true; // Sukces        } else {            return false; // Błąd zapisu        }    }		// tylko do testów	function debugCurlRequest($ch)	{		// Pobranie szczegółowych informacji o połączeniu		$info = curl_getinfo($ch);		$erp=  "<pre>";		$erp+=  "Request Details:\n";		$erp+=  "================\n";		// URL żądania		$erp+=  "URL: " . $info['url'] . "\n";		// Metoda HTTP		$erp+=  "HTTP Method: " . (isset($info['http_method']) ? $info['http_method'] : 'POST/GET') . "\n";		// Kod odpowiedzi HTTP		$erp+= "HTTP Code: " . $info['http_code'] . "\n";				zapisDoPlikuWModul($erp, 'curl');	   	}				 }