<!DOCTYPE html>
<html>
<head>
    <title>Szybki test aktualizacji ceny wysy≈Çki</title>
</head>
<body>
    <h1>Test aktualizacji ceny wysy≈Çki - Produkt 2681</h1>
    
    <div style="border: 2px solid #ccc; padding: 15px; margin: 10px 0;">
        <h2>Symulacja elementu z modal.tpl:</h2>
        <span class="delivery-text">Dostawa 
            <span class="dynamic-shipping-price" data-product-id="2681" id="price-display" style="font-weight: bold; color: blue;">
                ≈Çadowanie...
            </span>
        </span>
    </div>
    
    <div>
        <button onclick="testCurrentLogic()" style="padding: 10px; background: green; color: white; border: none; margin: 5px;">
            ‚úÖ Test NOWEJ logiki (powinno byƒá 67,65 z≈Ç)
        </button>
        <button onclick="testOldLogic()" style="padding: 10px; background: red; color: white; border: none; margin: 5px;">
            ‚ùå Test STAREJ logiki (by≈Ço 55,00 z≈Ç)
        </button>
        <button onclick="clearCache()" style="padding: 10px; background: orange; color: white; border: none; margin: 5px;">
            üîÑ Wyczy≈õƒá cache
        </button>
    </div>
    
    <div id="log" style="background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; min-height: 200px; border: 1px solid #ddd;">
        <strong>Log dzia≈Çania:</strong><br>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        const priceDisplay = document.getElementById('price-display');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearCache() {
            if (window.currentMaxShippingCost) {
                log(`üóëÔ∏è Czyszczenie cache (by≈Ço: ${window.currentMaxShippingCost})`);
                window.currentMaxShippingCost = 0;
            } else {
                log('üóëÔ∏è Cache ju≈º wyczyszczony lub nie istnieje');
            }
        }
        
        function testCurrentLogic() {
            log('üîÑ Test NOWEJ logiki (getShippingInfo)...');
            priceDisplay.textContent = '≈Çadowanie...';
            priceDisplay.style.color = 'blue';
            
            fetch('/kopia_norwit/modules/relatedproducts/ajax.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'action=getShippingInfo&id_product=2681'
            })
            .then(response => response.json())
            .then(data => {
                log(`üì¶ Odpowied≈∫: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success && data.formatted_price) {
                    priceDisplay.textContent = data.formatted_price;
                    priceDisplay.style.color = 'green';
                    log(`‚úÖ SUKCES! Wy≈õwietlono: ${data.formatted_price}`);
                    log(`   ‚Ä¢ Cena brutto: ${data.lowest_price} z≈Ç`);
                    log(`   ‚Ä¢ Przewo≈∫nik: ${data.carrier_name}`);
                    
                    // Symuluj ustawienie cache (jak robi prawdziwy JavaScript)
                    window.currentMaxShippingCost = data.lowest_price;
                    log(`üíæ Ustawiono cache: ${data.lowest_price}`);
                } else {
                    priceDisplay.textContent = 'B≈ÅƒÑD';
                    priceDisplay.style.color = 'red';
                    log('‚ùå B≈ÇƒÖd w odpowiedzi API');
                }
            })
            .catch(error => {
                log(`‚ùå B≈ÇƒÖd sieci: ${error.message}`);
                priceDisplay.textContent = 'B≈ÅƒÑD SIECI';
                priceDisplay.style.color = 'red';
            });
        }
        
        function testOldLogic() {
            log('üîÑ Test STAREJ logiki (getShippingCost)...');
            priceDisplay.textContent = '≈Çadowanie...';
            priceDisplay.style.color = 'blue';
            
            fetch('/kopia_norwit/modules/relatedproducts/ajax.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'action=getShippingCost&id_product=2681'
            })
            .then(response => response.json())
            .then(data => {
                log(`üì¶ Odpowied≈∫: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success && data.formatted_cost) {
                    priceDisplay.textContent = `od ${data.formatted_cost}`;
                    priceDisplay.style.color = 'red';
                    log(`‚ùå STARA LOGIKA: od ${data.formatted_cost}`);
                    log(`   ‚Ä¢ Problem: To tylko ${data.shipping_cost} z≈Ç netto!`);
                    log(`   ‚Ä¢ Brakuje: VAT + additional_shipping_cost`);
                } else {
                    priceDisplay.textContent = 'B≈ÅƒÑD';
                    priceDisplay.style.color = 'red';
                    log('‚ùå B≈ÇƒÖd w odpowiedzi API');
                }
            })
            .catch(error => {
                log(`‚ùå B≈ÇƒÖd sieci: ${error.message}`);
                priceDisplay.textContent = 'B≈ÅƒÑD SIECI';
                priceDisplay.style.color = 'red';
            });
        }
        
        // Auto-test przy ≈Çadowaniu
        window.onload = function() {
            log('üöÄ Strona za≈Çadowana - uruchamiam test...');
            setTimeout(testCurrentLogic, 500);
        };
    </script>
</body>
</html>